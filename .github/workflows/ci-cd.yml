name: Complete CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  APP_NAME: money-transfer
  JAVA_VERSION: '17'
  SONAR_HOST_URL: http://13.126.34.38:9000
  NEXUS_URL: http://13.126.34.38:8081
  NEXUS_REPOSITORY: maven-releases
  NEXUS_DOCKER_REGISTRY: 13.126.34.38:8082

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4
      
      - name: 2. Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven
      
      - name: 3. Build Application
        run: |
          echo "Building project..."
          if [ -d "money-transfer" ]; then
            cd money-transfer
          fi
          mvn clean compile
      
      - name: 4. Run Unit Tests
        run: |
          if [ -d "money-transfer" ]; then
            cd money-transfer
          fi
          mvn test
      
      - name: 5. SonarQube Analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          if [ -d "money-transfer" ]; then
            cd money-transfer
          fi
          mvn sonar:sonar \
            -Dsonar.projectKey=money-transfer \
            -Dsonar.projectName="Money Transfer" \
            -Dsonar.host.url=${{ env.SONAR_HOST_URL }} \
            -Dsonar.token=${{ secrets.SONAR_TOKEN }}
      
      - name: 6. Package Application
        run: |
          if [ -d "money-transfer" ]; then
            cd money-transfer
          fi
          mvn package -DskipTests
      
      - name: 7. Upload JAR to Nexus
        env:
          NEXUS_USER: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASS: ${{ secrets.NEXUS_PASSWORD }}
        run: |
          if [ -d "money-transfer" ]; then
            cd money-transfer
          fi
          
          JAR_FILE=$(ls target/*.jar | head -1)
          VERSION="1.0.${{ github.run_number }}"
          
          echo "Uploading $JAR_FILE to Nexus..."
          
          curl -v -u $NEXUS_USER:$NEXUS_PASS \
            --upload-file $JAR_FILE \
            ${{ env.NEXUS_URL }}/repository/${{ env.NEXUS_REPOSITORY }}/com/example/${{ env.APP_NAME }}/$VERSION/${{ env.APP_NAME }}-$VERSION.jar
          
          echo "JAR uploaded to Nexus!"
      
      
      - name: 10. Summary
        run: |
          echo "========================================="
          echo "  PIPELINE COMPLETED SUCCESSFULLY!"
          echo "========================================="
          echo ""
          echo "Build Number: ${{ github.run_number }}"
          echo "Version: 1.0.${{ github.run_number }}"
          echo ""
          echo "SonarQube: ${{ env.SONAR_HOST_URL }}/dashboard?id=money-transfer"
          echo "Nexus: ${{ env.NEXUS_URL }}"
          echo ""