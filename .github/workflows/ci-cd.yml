name: Money Transfer Pipeline - CI/CD with Shift-Left Testing

on:
  push:
    branches: [ main, develop, feature/** ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: '-Xmx3072m'

jobs:
  # Job 1: Static Code Analysis (Shift-Left)
  static-analysis:
    name: üîç Static Code Analysis
    runs-on: ubuntu-latest
    if: false
    defaults:
      run:
        working-directory: ./money-transfer
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ‚òï Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: üèóÔ∏è Build Project
      run: mvn clean compile -DskipTests -B
    
    - name: üîç Run Checkstyle
      run: |
        echo "Running Checkstyle for code style violations..."
        mvn checkstyle:checkstyle -B || true
      continue-on-error: true
    
    - name: üìä Run PMD
      run: |
        echo "Running PMD for code quality issues..."
        mvn pmd:pmd -B || true
      continue-on-error: true
    
    - name: üìã Analysis Summary
      if: always()
      run: |
        echo "=================================="
        echo "Static Analysis Complete"
        echo "=================================="
        if [ -f "target/site/checkstyle.html" ]; then
          echo "‚úÖ Checkstyle report generated"
        fi
        if [ -f "target/site/pmd.html" ]; then
          echo "‚úÖ PMD report generated"
        fi
        echo "Download reports from Artifacts"
        echo "=================================="
    
    - name: üì§ Upload Checkstyle Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: checkstyle-report
        path: money-transfer/target/site/checkstyle.html
        if-no-files-found: warn
    
    - name: üì§ Upload PMD Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pmd-report
        path: money-transfer/target/site/pmd.html
        if-no-files-found: warn

  # Job 2: Security Scan (Gitleaks Only - Fast)
  security-scan:
    name: üîí Security Scan
    runs-on: ubuntu-latest
    if: false
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: üîê Check for Secrets with Gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true
    
    - name: üìã Security Summary
      if: always()
      run: |
        echo "=================================="
        echo "Security Scan Complete"
        echo "=================================="
        echo "‚úÖ Gitleaks secret scan completed"
        echo "Note: OWASP Dependency Check removed for speed"
        echo "Recommendation: Run OWASP separately weekly"
        echo "=================================="

  # Job 3: Build and Unit Tests
  build-and-test:
    name: üèóÔ∏è Build & Unit Tests
    runs-on: ubuntu-latest
    needs: [static-analysis, security-scan]
    defaults:
      run:
        working-directory: ./money-transfer
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: ‚òï Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: üîç Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: üèóÔ∏è Compile code
      run: |
        echo "Compiling application..."
        mvn clean compile -B -V
    
    - name: üß™ Run Unit Tests
      run: |
        echo "Running unit tests (tagged with @Tag('unit'))..."
        mvn test -B
    
    - name: üìä Generate Test Report
      if: always()
      run: mvn surefire-report:report-only
    
    - name: üìä Test Summary
      if: always()
      run: |
        echo "=================================="
        echo "Unit Test Results"
        echo "=================================="
        if ls target/surefire-reports/TEST-*.xml 1> /dev/null 2>&1; then
          echo "‚úÖ Test reports generated"
          cat target/surefire-reports/*.txt 2>/dev/null || echo "Summary files not found"
        else
          echo "‚ö†Ô∏è  No test results found"
        fi
        echo "=================================="
    
    - name: üì§ Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results
        path: |
          money-transfer/target/surefire-reports/
          money-transfer/target/site/surefire-report.html
        if-no-files-found: warn
        retention-days: 30

  # Job 4: Integration Tests
  integration-tests:
    name: üîó Integration Tests
    runs-on: ubuntu-latest
    if: false
    needs: build-and-test
    defaults:
      run:
        working-directory: ./money-transfer
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: ‚òï Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: üîç Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: üîó Run Integration Tests
      run: |
        echo "Running integration tests (tagged with @Tag('integration'))..."
        mvn verify -DskipUnitTests -B
    
    - name: üìä Generate Integration Test Report
      if: always()
      run: mvn failsafe-report:report-only || true
    
    - name: üìä Test Summary
      if: always()
      run: |
        echo "=================================="
        echo "Integration Test Results"
        echo "=================================="
        if ls target/failsafe-reports/TEST-*.xml 1> /dev/null 2>&1; then
          echo "‚úÖ Test reports generated"
          cat target/failsafe-reports/*.txt 2>/dev/null || echo "Summary files not found"
        else
          echo "‚ö†Ô∏è  No test results found"
        fi
        echo "=================================="
    
    - name: üì§ Upload Integration Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: |
          money-transfer/target/failsafe-reports/
          money-transfer/target/site/failsafe-report.html
        if-no-files-found: warn
        retention-days: 30

  # Job 5: Code Coverage Analysis
  coverage-analysis:
    name: üìä Code Coverage Analysis
    runs-on: ubuntu-latest
    if: false
    needs: [build-and-test, integration-tests]
    defaults:
      run:
        working-directory: ./money-transfer
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: ‚òï Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: üîç Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: üìä Run Tests with Coverage
      run: |
        echo "Running all tests with coverage tracking..."
        mvn clean verify -B
    
    - name: üìà Check Coverage Threshold
      run: |
        echo "Checking code coverage thresholds..."
        
        if [ -f "target/site/jacoco/jacoco.csv" ]; then
          INSTRUCTION_COVERAGE=$(awk -F, '
            NR>1 {
              instructions_missed += $4;
              instructions_covered += $5;
            }
            END {
              if (instructions_missed + instructions_covered > 0) {
                print int((instructions_covered * 100) / (instructions_missed + instructions_covered));
              } else {
                print 0;
              }
            }
          ' target/site/jacoco/jacoco.csv)
          
          BRANCH_COVERAGE=$(awk -F, '
            NR>1 {
              branches_missed += $6;
              branches_covered += $7;
            }
            END {
              if (branches_missed + branches_covered > 0) {
                print int((branches_covered * 100) / (branches_missed + branches_covered));
              } else {
                print 0;
              }
            }
          ' target/site/jacoco/jacoco.csv)
          
          echo "üìä Coverage Results:"
          echo "   Instruction Coverage: ${INSTRUCTION_COVERAGE}%"
          echo "   Branch Coverage: ${BRANCH_COVERAGE}%"
          
          MIN_INSTRUCTION_COVERAGE=10
          MIN_BRANCH_COVERAGE=10
          
          if [ "$INSTRUCTION_COVERAGE" -lt "$MIN_INSTRUCTION_COVERAGE" ]; then
            echo "‚ùå Instruction coverage ${INSTRUCTION_COVERAGE}% is below threshold ${MIN_INSTRUCTION_COVERAGE}%"
            exit 1
          fi
          
          if [ "$BRANCH_COVERAGE" -lt "$MIN_BRANCH_COVERAGE" ]; then
            echo "‚ö†Ô∏è  Branch coverage ${BRANCH_COVERAGE}% is below threshold ${MIN_BRANCH_COVERAGE}%"
            echo "    This is a warning, not blocking the build"
          fi
          
          echo "‚úÖ Coverage thresholds met!"
          echo "INSTRUCTION_COVERAGE=${INSTRUCTION_COVERAGE}" >> $GITHUB_ENV
          echo "BRANCH_COVERAGE=${BRANCH_COVERAGE}" >> $GITHUB_ENV
        else
          echo "‚ö†Ô∏è  No coverage report found"
        fi
    
    - name: üì§ Upload Coverage Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: money-transfer/target/site/jacoco/
        retention-days: 30
    
    - name: üí¨ Comment Coverage on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const coverage = process.env.INSTRUCTION_COVERAGE || 'N/A';
          const branch = process.env.BRANCH_COVERAGE || 'N/A';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## üìä Code Coverage Report\n\n` +
                  `- **Instruction Coverage:** ${coverage}%\n` +
                  `- **Branch Coverage:** ${branch}%\n\n` +
                  `‚úÖ Coverage thresholds met!\n\n` +
                  `[View detailed report in artifacts](${context.payload.repository.html_url}/actions/runs/${context.runId})`
          });

  # Job 6: Smoke & Performance Tests
  smoke-and-performance-tests:
    name: üî• Smoke & Performance Tests
    runs-on: ubuntu-latest
    if: false
    needs: integration-tests
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'
    defaults:
      run:
        working-directory: ./money-transfer
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: ‚òï Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: üì¶ Package Application
      run: mvn clean package -DskipTests -B
    
    - name: üöÄ Start Application
      run: |
        echo "üî• Starting application for smoke tests..."
        java -jar target/*.jar &
        APP_PID=$!
        echo "APP_PID=$APP_PID" >> $GITHUB_ENV
        
        echo "Waiting for application to be ready..."
        timeout 60 bash -c 'until curl -f http://localhost:8080/actuator/health; do sleep 2; done' || {
          echo "‚ùå Application failed to start"
          exit 1
        }
        
        echo "‚úÖ Application started successfully"
    
    - name: üî• Run Smoke Tests
      run: |
        echo "=================================="
        echo "Running Smoke Tests"
        echo "=================================="
        
        echo "üî• Smoke Test 1: Health endpoint..."
        curl -f http://localhost:8080/actuator/health || exit 1
        echo "‚úÖ Health endpoint OK"
        
        echo "üî• Smoke Test 2: API endpoints..."
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/accounts)
        if [ "$HTTP_CODE" == "200" ] || [ "$HTTP_CODE" == "404" ]; then
          echo "‚úÖ API responding (HTTP $HTTP_CODE)"
        else
          echo "‚ùå API not responding (HTTP $HTTP_CODE)"
          exit 1
        fi
        
        echo "‚úÖ All smoke tests passed!"
    
    - name: ‚ö° Run Performance Tests
      run: |
        echo "=================================="
        echo "Running Performance Tests"
        echo "=================================="
        
        HEALTH_TIME=$(curl -o /dev/null -s -w '%{time_total}\n' http://localhost:8080/actuator/health)
        echo "‚ö° Health response: ${HEALTH_TIME}s"
        
        echo "‚ö° Load test: 100 concurrent requests..."
        START_TIME=$(date +%s)
        for i in {1..100}; do
          curl -s http://localhost:8080/actuator/health > /dev/null &
        done
        wait
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        
        if [ $DURATION -eq 0 ]; then
          THROUGHPUT=100
        else
          THROUGHPUT=$((100 / DURATION))
        fi
        
        echo "üìä Performance Summary:"
        echo "   Response time: ${HEALTH_TIME}s"
        echo "   Load duration: ${DURATION}s"
        echo "   Throughput: ${THROUGHPUT} req/s"
        
        if (( $(echo "$HEALTH_TIME > 1.0" | bc -l) )); then
          echo "‚ö†Ô∏è  Response time exceeds 1 second"
        else
          echo "‚úÖ Performance acceptable"
        fi
        
        echo "HEALTH_TIME=${HEALTH_TIME}" >> $GITHUB_ENV
        echo "THROUGHPUT=${THROUGHPUT}" >> $GITHUB_ENV
      continue-on-error: true
    
    - name: üõë Stop Application
      if: always()
      run: |
        if [ ! -z "$APP_PID" ]; then
          echo "Stopping application (PID: $APP_PID)..."
          kill $APP_PID 2>/dev/null || true
          sleep 2
        fi
    
    - name: üí¨ Comment Results on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const healthTime = process.env.HEALTH_TIME || 'N/A';
          const throughput = process.env.THROUGHPUT || 'N/A';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## üî• Smoke & Performance Test Results\n\n` +
                  `### Smoke Tests\n` +
                  `‚úÖ Application starts successfully\n` +
                  `‚úÖ Health endpoint accessible\n` +
                  `‚úÖ API endpoints responding\n\n` +
                  `### Performance\n` +
                  `- **Response Time:** ${healthTime}s\n` +
                  `- **Throughput:** ${throughput} req/s\n\n` +
                  `${healthTime !== 'N/A' && parseFloat(healthTime) < 1.0 ? '‚úÖ' : '‚ö†Ô∏è'} Performance within limits`
          });
      continue-on-error: true

  # Job 7: Contract Testing (API Validation)
  contract-tests:
    name: üìã Contract Tests
    runs-on: ubuntu-latest
    needs: integration-tests
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'
    defaults:
      run:
        working-directory: ./money-transfer
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: ‚òï Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: üìã Generate API Contract/Schema
      run: |
        echo "=================================="
        echo "Generating API Contract"
        echo "=================================="
        
        # Create contracts directory
        mkdir -p target/contracts
        
        # Generate OpenAPI/Swagger specification
        cat > target/contracts/api-contract.json << 'EOF'
        {
          "openapi": "3.0.0",
          "info": {
            "title": "Money Transfer API",
            "version": "1.0.0",
            "description": "API contract for Money Transfer Service"
          },
          "paths": {
            "/api/accounts": {
              "post": {
                "summary": "Create new account",
                "requestBody": {
                  "required": true,
                  "content": {
                    "application/json": {
                      "schema": {
                        "type": "object",
                        "required": ["accountHolderName", "initialBalance"],
                        "properties": {
                          "accountHolderName": {
                            "type": "string",
                            "minLength": 1
                          },
                          "initialBalance": {
                            "type": "number",
                            "minimum": 0
                          }
                        }
                      }
                    }
                  }
                },
                "responses": {
                  "201": {
                    "description": "Account created"
                  }
                }
              },
              "get": {
                "summary": "Get all accounts",
                "responses": {
                  "200": {
                    "description": "List of accounts"
                  }
                }
              }
            },
            "/api/accounts/{id}": {
              "get": {
                "summary": "Get account by ID",
                "parameters": [
                  {
                    "name": "id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Account details"
                  },
                  "404": {
                    "description": "Account not found"
                  }
                }
              }
            },
            "/api/transfer": {
              "post": {
                "summary": "Transfer money between accounts",
                "requestBody": {
                  "required": true,
                  "content": {
                    "application/json": {
                      "schema": {
                        "type": "object",
                        "required": ["fromAccountId", "toAccountId", "amount"],
                        "properties": {
                          "fromAccountId": {
                            "type": "integer"
                          },
                          "toAccountId": {
                            "type": "integer"
                          },
                          "amount": {
                            "type": "number",
                            "minimum": 0.01
                          }
                        }
                      }
                    }
                  }
                },
                "responses": {
                  "200": {
                    "description": "Transfer successful"
                  },
                  "400": {
                    "description": "Invalid transfer request"
                  }
                }
              }
            },
            "/actuator/health": {
              "get": {
                "summary": "Health check endpoint",
                "responses": {
                  "200": {
                    "description": "Service is healthy"
                  }
                }
              }
            }
          }
        }
        EOF
        
        echo "‚úÖ API contract generated"
        cat target/contracts/api-contract.json | head -20
    
    - name: üì¶ Package Application
      run: mvn clean package -DskipTests -B
    
    - name: üöÄ Start Application
      run: |
        echo "Starting application for contract validation..."
        java -jar target/*.jar &
        APP_PID=$!
        echo "APP_PID=$APP_PID" >> $GITHUB_ENV
        
        echo "Waiting for application to be ready..."
        timeout 60 bash -c 'until curl -f http://localhost:8080/actuator/health; do sleep 2; done' || {
          echo "‚ùå Application failed to start"
          exit 1
        }
        
        echo "‚úÖ Application started"
    
    - name: üìã Validate API Contracts
      run: |
        echo "=================================="
        echo "Validating API Contracts"
        echo "=================================="
        
        CONTRACT_VIOLATIONS=0
        
        # Test 1: POST /api/accounts - Create Account
        echo "üìã Test 1: Create Account Endpoint"
        RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/api/accounts \
          -H "Content-Type: application/json" \
          -d '{"accountHolderName":"TestUser","initialBalance":1000.00}')
        
        HTTP_CODE=$(echo "$RESPONSE" | tail -1)
        BODY=$(echo "$RESPONSE" | head -n -1)
        
        if [ "$HTTP_CODE" == "201" ] || [ "$HTTP_CODE" == "200" ]; then
          echo "‚úÖ Create Account: HTTP $HTTP_CODE (Expected: 200/201)"
        else
          echo "‚ùå Create Account: HTTP $HTTP_CODE (Expected: 200/201)"
          CONTRACT_VIOLATIONS=$((CONTRACT_VIOLATIONS + 1))
        fi
        
        # Test 2: GET /api/accounts - List Accounts
        echo "üìã Test 2: List Accounts Endpoint"
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/accounts)
        
        if [ "$HTTP_CODE" == "200" ]; then
          echo "‚úÖ List Accounts: HTTP $HTTP_CODE (Expected: 200)"
        else
          echo "‚ùå List Accounts: HTTP $HTTP_CODE (Expected: 200)"
          CONTRACT_VIOLATIONS=$((CONTRACT_VIOLATIONS + 1))
        fi
        
        # Test 3: GET /api/accounts/{id} - Get Account by ID
        echo "üìã Test 3: Get Account by ID Endpoint"
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/accounts/1)
        
        if [ "$HTTP_CODE" == "200" ] || [ "$HTTP_CODE" == "404" ]; then
          echo "‚úÖ Get Account: HTTP $HTTP_CODE (Expected: 200/404)"
        else
          echo "‚ùå Get Account: HTTP $HTTP_CODE (Expected: 200/404)"
          CONTRACT_VIOLATIONS=$((CONTRACT_VIOLATIONS + 1))
        fi
        
        # Test 4: POST /api/transfer - Invalid Request (missing fields)
        echo "üìã Test 4: Transfer with Invalid Data"
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8080/api/transfer \
          -H "Content-Type: application/json" \
          -d '{"fromAccountId":1}')
        
        if [ "$HTTP_CODE" == "400" ]; then
          echo "‚úÖ Invalid Transfer: HTTP $HTTP_CODE (Expected: 400)"
        else
          echo "‚ö†Ô∏è  Invalid Transfer: HTTP $HTTP_CODE (Expected: 400, but may vary)"
        fi
        
        # Test 5: POST /api/transfer - Valid Request Structure
        echo "üìã Test 5: Transfer with Valid Structure"
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8080/api/transfer \
          -H "Content-Type: application/json" \
          -d '{"fromAccountId":1,"toAccountId":2,"amount":100.00}')
        
        if [ "$HTTP_CODE" == "200" ] || [ "$HTTP_CODE" == "400" ] || [ "$HTTP_CODE" == "404" ]; then
          echo "‚úÖ Valid Transfer Request: HTTP $HTTP_CODE (Acceptable)"
        else
          echo "‚ùå Valid Transfer Request: HTTP $HTTP_CODE (Unexpected)"
          CONTRACT_VIOLATIONS=$((CONTRACT_VIOLATIONS + 1))
        fi
        
        # Test 6: GET /actuator/health - Health Check
        echo "üìã Test 6: Health Check Endpoint"
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/actuator/health)
        
        if [ "$HTTP_CODE" == "200" ]; then
          echo "‚úÖ Health Check: HTTP $HTTP_CODE (Expected: 200)"
        else
          echo "‚ùå Health Check: HTTP $HTTP_CODE (Expected: 200)"
          CONTRACT_VIOLATIONS=$((CONTRACT_VIOLATIONS + 1))
        fi
        
        # Summary
        echo ""
        echo "=================================="
        echo "Contract Validation Summary"
        echo "=================================="
        echo "Contract Violations: $CONTRACT_VIOLATIONS"
        
        if [ $CONTRACT_VIOLATIONS -eq 0 ]; then
          echo "‚úÖ All API contracts validated successfully!"
        else
          echo "‚ùå Contract validation failed with $CONTRACT_VIOLATIONS violations"
          echo "‚ö†Ô∏è  API changes may break downstream consumers!"
        fi
        
        echo "CONTRACT_VIOLATIONS=$CONTRACT_VIOLATIONS" >> $GITHUB_ENV
    
    - name: üõë Stop Application
      if: always()
      run: |
        if [ ! -z "$APP_PID" ]; then
          echo "Stopping application..."
          kill $APP_PID 2>/dev/null || true
          sleep 2
        fi
    
    - name: üì§ Upload API Contract
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: api-contract
        path: money-transfer/target/contracts/
        retention-days: 90
    
    - name: üí¨ Comment Contract Results on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const violations = process.env.CONTRACT_VIOLATIONS || '0';
          const status = violations === '0' ? '‚úÖ' : '‚ùå';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## üìã API Contract Validation\n\n` +
                  `${status} Contract Violations: ${violations}\n\n` +
                  `### Tests Performed:\n` +
                  `- ‚úÖ POST /api/accounts (Create Account)\n` +
                  `- ‚úÖ GET /api/accounts (List Accounts)\n` +
                  `- ‚úÖ GET /api/accounts/{id} (Get Account)\n` +
                  `- ‚úÖ POST /api/transfer (Transfer Money)\n` +
                  `- ‚úÖ GET /actuator/health (Health Check)\n\n` +
                  `${violations === '0' ? '‚úÖ All API contracts validated! Safe to merge.' : '‚ö†Ô∏è API changes detected! Review breaking changes before merging.'}\n\n` +
                  `[Download API Contract](${context.payload.repository.html_url}/actions/runs/${context.runId})`
          });
      continue-on-error: true
    
    - name: ‚ùå Fail on Contract Violations
      if: env.CONTRACT_VIOLATIONS != '0'
      run: |
        echo "=================================="
        echo "‚ùå CONTRACT VALIDATION FAILED"
        echo "=================================="
        echo "Breaking changes detected in API contract!"
        echo "This may break downstream consumers."
        echo ""
        echo "Action required:"
        echo "1. Review API changes"
        echo "2. Update API version if needed"
        echo "3. Notify downstream consumers"
        echo "4. Update documentation"
        echo "=================================="
        exit 1    