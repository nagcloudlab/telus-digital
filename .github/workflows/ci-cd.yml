name: Complete CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  APP_NAME: money-transfer
  JAVA_VERSION: '17'
  SONAR_HOST_URL: http://13.126.34.38:9000
  NEXUS_URL: http://13.126.34.38:8081
  NEXUS_REPOSITORY: maven-releases
  NEXUS_DOCKER_REGISTRY: 13.126.34.38:8082

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4
      
      - name: 2. Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven
      
      - name: 3. Build Application
        run: |
          echo "Building project..."
          if [ -d "money-transfer" ]; then
            cd money-transfer
          fi
          mvn clean compile
      
      - name: 4. Run Unit Tests
        run: |
          if [ -d "money-transfer" ]; then
            cd money-transfer
          fi
          mvn test
      
      - name: 5. SonarQube Analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          if [ -d "money-transfer" ]; then
            cd money-transfer
          fi
          mvn sonar:sonar \
            -Dsonar.projectKey=money-transfer \
            -Dsonar.projectName="Money Transfer" \
            -Dsonar.host.url=${{ env.SONAR_HOST_URL }} \
            -Dsonar.token=${{ secrets.SONAR_TOKEN }}
      
      - name: 6. Package Application
        run: |
          if [ -d "money-transfer" ]; then
            cd money-transfer
          fi
          mvn package -DskipTests
      
      - name: 7. Upload JAR to Nexus
        env:
          NEXUS_USER: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASS: ${{ secrets.NEXUS_PASSWORD }}
        run: |
          if [ -d "money-transfer" ]; then
            cd money-transfer
          fi
          
          JAR_FILE=$(ls target/*.jar | head -1)
          VERSION="1.0.${{ github.run_number }}"
          
          echo "Uploading $JAR_FILE to Nexus..."
          
          curl -v -u $NEXUS_USER:$NEXUS_PASS \
            --upload-file $JAR_FILE \
            ${{ env.NEXUS_URL }}/repository/${{ env.NEXUS_REPOSITORY }}/com/example/${{ env.APP_NAME }}/$VERSION/${{ env.APP_NAME }}-$VERSION.jar
          
          echo "âœ… JAR uploaded to Nexus!"
      
      - name: 8. Build Docker Image
        run: |
          if [ -d "money-transfer" ]; then
            cd money-transfer
          fi
          
          VERSION="1.0.${{ github.run_number }}"
          
          # Check if Dockerfile exists, if not create it
          if [ ! -f "Dockerfile" ]; then
            cat > Dockerfile << 'EOF'
FROM openjdk:17-jdk-slim
LABEL maintainer="nag@example.com"
LABEL application="money-transfer"
WORKDIR /app
COPY target/*.jar app.jar
EXPOSE 8080
HEALTHCHECK --interval=30s --timeout=3s --retries=3 \
  CMD curl -f http://localhost:8080/actuator/health || exit 1
ENTRYPOINT ["java", "-jar", "app.jar"]
EOF
          fi
          
          docker build -t ${{ env.NEXUS_DOCKER_REGISTRY }}/${{ env.APP_NAME }}:$VERSION .
          docker tag ${{ env.NEXUS_DOCKER_REGISTRY }}/${{ env.APP_NAME }}:$VERSION \
                     ${{ env.NEXUS_DOCKER_REGISTRY }}/${{ env.APP_NAME }}:latest
      
      - name: 9. Push Docker Image to Nexus
        env:
          NEXUS_USER: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASS: ${{ secrets.NEXUS_PASSWORD }}
        run: |
          VERSION="1.0.${{ github.run_number }}"
          
          echo $NEXUS_PASS | docker login -u $NEXUS_USER --password-stdin ${{ env.NEXUS_DOCKER_REGISTRY }}
          
          docker push ${{ env.NEXUS_DOCKER_REGISTRY }}/${{ env.APP_NAME }}:$VERSION
          docker push ${{ env.NEXUS_DOCKER_REGISTRY }}/${{ env.APP_NAME }}:latest
          
          docker logout ${{ env.NEXUS_DOCKER_REGISTRY }}
          
          echo "âœ… Docker images pushed to Nexus!"
      
      - name: 10. Summary
        run: |
          echo "========================================="
          echo "  âœ… PIPELINE COMPLETED SUCCESSFULLY!"
          echo "========================================="
          echo ""
          echo "Build Number: ${{ github.run_number }}"
          echo "Version: 1.0.${{ github.run_number }}"
          echo ""
          echo "ðŸ“Š SonarQube: ${{ env.SONAR_HOST_URL }}/dashboard?id=money-transfer"
          echo "ðŸ“¦ Nexus: ${{ env.NEXUS_URL }}"
          echo "ðŸ³ Docker: ${{ env.NEXUS_DOCKER_REGISTRY }}/${{ env.APP_NAME }}:1.0.${{ github.run_number }}"
          echo ""